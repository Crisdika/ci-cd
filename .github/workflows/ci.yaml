name: Lint (Ruff)

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Instalar depend√™ncias
        run: pip install -r requirements-dev.txt

      - name: Rodar Ruff e exibir resumo e detalhes
        run: |
          echo "üîç Rodando Ruff..."
          
          # Executa Ruff e salva a sa√≠da completa em um arquivo
          ruff check . > ruff_output.txt || true

          echo ""
          echo "üìä ===== RESUMO DE ERROS POR TIPO ====="
          if grep -qE '\b[A-Z][0-9]{3}\b' ruff_output.txt; then
            grep -oE '\b[A-Z][0-9]{3}\b' ruff_output.txt \
              | sort \
              | uniq -c \
              | sort -nr \
              | awk '{printf "Erro %s > %d\n", $2, $1, " vezes"}'
          else
            echo "‚úÖ Nenhum erro encontrado!"
          fi

          echo ""
          echo "üßæ ===== DETALHES COMPLETOS DO RUFF ====="
          cat ruff_output.txt

          # Se houve erros, falha o job no final
          if grep -qE '\b[A-Z][0-9]{3}\b' ruff_output.txt; then
            echo ""
            echo "‚ùå Ruff encontrou problemas. Corrija antes de prosseguir."
            exit 1
          else
            echo ""
            echo "‚úÖ C√≥digo limpo ‚Äî sem erros de lint!"
          fi
